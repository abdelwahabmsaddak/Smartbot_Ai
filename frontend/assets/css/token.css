// assets/js/token_generator.js

function generateContractCode(data) {
    const {
        network,
        name,
        symbol,
        supply,
        decimals,
        burnable,
        mintable,
        taxable,
    } = data;

    const networkComment =
        network === "bsc"
            ? "// Network: Binance Smart Chain (BEP-20)\n"
            : "// Network: Ethereum (ERC-20)\n";

    const burnableCode = burnable
        ? `
    function burn(uint256 amount) public {
        _burn(msg.sender, amount);
    }`
        : "";

    const mintableCode = mintable
        ? `
    function mint(address to, uint256 amount) external onlyOwner {
        _mint(to, amount);
    }`
        : "";

    const taxState = taxable
        ? `
    uint256 public taxFee = 2; // 2% tax
    address public taxWallet = msg.sender;`
        : "";

    const taxTransfer = taxable
        ? `
    function _transfer(address from, address to, uint256 amount) internal override {
        if (taxFee > 0 && to != taxWallet && from != taxWallet) {
            uint256 feeAmount = (amount * taxFee) / 100;
            uint256 sendAmount = amount - feeAmount;
            super._transfer(from, taxWallet, feeAmount);
            super._transfer(from, to, sendAmount);
        } else {
            super._transfer(from, to, amount);
        }
    }`
        : "";

    const totalSupplyCalc = `${supply} * 10 ** ${decimals}`;

    return `${networkComment}// Auto-generated by SmartBot AI Token Generator
// Basic example – review before using in production

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract ${symbol}Token is ERC20, Ownable {

    uint8 private _customDecimals = ${decimals};
    ${taxState}

    constructor() ERC20("${name}", "${symbol}") {
        _mint(msg.sender, ${totalSupplyCalc});
    }

    function decimals() public view virtual override returns (uint8) {
        return _customDecimals;
    }
    ${burnableCode}
    ${mintableCode}
    ${taxTransfer}
}
`;
}

document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("tokenForm");
    const output = document.getElementById("contractCode");
    const copyBtn = document.getElementById("copyCodeBtn");

    if (!form || !output) return;

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const data = {
            network: document.getElementById("network").value,
            name: document.getElementById("name").value.trim(),
            symbol: document.getElementById("symbol").value.trim().toUpperCase(),
            supply: document.getElementById("supply").value || "1000000",
            decimals: document.getElementById("decimals").value || "18",
            burnable: document.getElementById("burnable").checked,
            mintable: document.getElementById("mintable").checked,
            taxable: document.getElementById("taxable").checked,
        };

        if (!data.name || !data.symbol) {
            alert("رجاءً أدخل اسم العملة والرمز.");
            return;
        }

        const code = generateContractCode(data);
        output.value = code;

        output.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    if (copyBtn && output) {
        copyBtn.addEventListener("click", () => {
            output.select();
            output.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                copyBtn.innerText = "✔️ تم النسخ";
                setTimeout(() => (copyBtn.innerText = "نسخ الكود"), 2000);
            } catch (err) {
                alert("لم يتم النسخ تلقائياً، انسخ الكود يدويًا.");
            }
        });
    }
});
